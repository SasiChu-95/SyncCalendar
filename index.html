<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncSpace - Recovery Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .calendar-day { min-height: 120px; }
    </style>
</head>
<body class="text-gray-800">
    <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
        <h3 class="font-bold">เครื่องมือกู้ข้อมูล (Recovery Tool)</h3>
        <p>หน้านี้เป็นเวอร์ชันเก่าสำหรับเข้าถึงข้อมูลเดิมของคุณเท่านั้น กรุณาทำตามคำแนะนำเพื่อคัดลอกข้อมูล จากนั้นกลับไปใช้เวอร์ชันล่าสุดที่ Deploy ไว้</p>
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center sticky top-0 z-40 border-b border-gray-200">
        <div>
            <h1 class="text-xl md:text-2xl font-bold text-indigo-600">SyncSpace (Recovery)</h1>
        </div>
        <div id="authContainer">
            <div id="loggedInView" class="hidden items-center space-x-2">
                 <span id="usernameDisplay" class="text-sm text-gray-800 font-bold"></span>
                <button id="logoutButton" class="px-3 py-1.5 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600">ออกจากระบบ</button>
            </div>
            <div id="loggedOutView" class="flex items-center space-x-2">
                <button id="loginButton" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">เข้าสู่ระบบ (ด้วยบัญชีเก่า)</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <h2 id="currentMonthYear" class="text-2xl font-bold text-center w-64"></h2>
                <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
            </div>
            <button id="todayButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-semibold">เดือนปัจจุบัน</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="grid grid-cols-7 border-t border-l border-gray-200">
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50 text-red-500">อา.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">จ.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">อ.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">พ.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">พฤ.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">ศ.</div>
                <div class="text-center font-semibold py-2 border-r border-b bg-gray-50">ส.</div>
                <div id="calendarDays" class="col-span-7 grid grid-cols-7"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 w-1/3">
            <h3 class="text-xl font-bold mb-4">เข้าสู่ระบบ (ข้อมูลเก่า)</h3>
            <form id="loginForm">
                <div class="space-y-4">
                    <input type="text" id="loginUsername" placeholder="ชื่อผู้ใช้" class="w-full border rounded-md p-2" required>
                    <input type="password" id="loginPassword" placeholder="รหัสผ่าน" class="w-full border rounded-md p-2" required>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="close-modal px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">เข้าสู่ระบบ</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="viewEventModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 hidden">
        <div class="bg-white rounded-lg p-6 w-1/3">
            <h3 class="text-lg font-bold mb-3">รายละเอียดนัดหมาย</h3>
            <div class="space-y-3" id="viewEventDetails"></div>
            <button class="close-modal mt-4 w-full px-4 py-2 bg-gray-200 rounded-lg">ปิด</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // This is the OLD logic to read the OLD data structure
            const calendarDaysEl = document.getElementById('calendarDays');
            const currentMonthYearEl = document.getElementById('currentMonthYear');
            const loginModal = document.getElementById('loginModal');
            const viewEventModal = document.getElementById('viewEventModal');
            
            let currentDate = new Date();
            let currentUser = null;
            let allUsersData = {};
            let events = []; // This will hold events for the logged-in user

            const loadUsers = () => {
                const data = localStorage.getItem('syncspace_users');
                if (data) {
                    allUsersData = JSON.parse(data);
                } else {
                    alert("ไม่พบข้อมูลเก่า (syncspace_users) ใน LocalStorage");
                }
            };
            
            const syncEvents = () => {
                if (currentUser && allUsersData[currentUser]) {
                    events = allUsersData[currentUser].events || [];
                } else {
                    events = [];
                }
                renderCalendar();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                currentMonthYearEl.textContent = new Intl.DateTimeFormat('th-TH', { month: 'long', year: 'numeric' }).format(currentDate);
                calendarDaysEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) calendarDaysEl.insertAdjacentHTML('beforeend', `<div class="border-r border-b p-2 bg-gray-50"></div>`);

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day border-r border-b p-2 flex flex-col';
                    dayEl.innerHTML = `<div class="font-medium">${day}</div>`;
                    
                    const dayEvents = events.filter(e => e.date === dateStr);
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'flex-grow overflow-y-auto space-y-1 mt-2';
                    dayEvents.forEach(event => {
                         const eventEl = document.createElement('div');
                         eventEl.className = 'text-xs bg-indigo-100 p-1 rounded-md cursor-pointer';
                         eventEl.textContent = event.title;
                         eventEl.onclick = () => {
                            const detailsEl = document.getElementById('viewEventDetails');
                            detailsEl.innerHTML = `
                                <p><strong>หัวข้อ:</strong> ${event.title}</p>
                                <p><strong>วันที่:</strong> ${event.date}</p>
                                <p><strong>เวลา:</strong> ${event.time || ''} - ${event.endTime || ''}</p>
                                <p><strong>สถานที่:</strong> ${event.location || ''}</p>
                                <p><strong>รายละเอียด:</strong> ${event.details || ''}</p>
                            `;
                            viewEventModal.classList.remove('hidden');
                         };
                         eventsContainer.appendChild(eventEl);
                    });
                    dayEl.appendChild(eventsContainer);
                    calendarDaysEl.appendChild(dayEl);
                }
            };

            const updateAuthUI = () => {
                const loggedInView = document.getElementById('loggedInView');
                const loggedOutView = document.getElementById('loggedOutView');
                if (currentUser) {
                    loggedInView.classList.remove('hidden');
                    loggedInView.classList.add('flex');
                    loggedOutView.classList.add('hidden');
                    document.getElementById('usernameDisplay').textContent = currentUser;
                } else {
                    loggedInView.classList.add('hidden');
                    loggedOutView.classList.remove('hidden');
                }
                syncEvents();
            };
            
            // --- Event Listeners ---
            document.getElementById('loginButton').onclick = () => loginModal.classList.remove('hidden');
            document.getElementById('logoutButton').onclick = () => {
                currentUser = null;
                sessionStorage.removeItem('syncspace_user_recovery');
                updateAuthUI();
            };
            document.querySelectorAll('.close-modal').forEach(btn => btn.onclick = () => btn.closest('.modal').classList.add('hidden'));
            
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.loginUsername.value;
                const password = e.target.loginPassword.value;
                if (allUsersData[username] && allUsersData[username].password === password) {
                    currentUser = username;
                    sessionStorage.setItem('syncspace_user_recovery', currentUser);
                    updateAuthUI();
                    loginModal.classList.add('hidden');
                } else {
                    alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                }
            });

            document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
            document.getElementById('todayButton').onclick = () => { currentDate = new Date(); renderCalendar(); };

            // --- Init ---
            loadUsers();
            currentUser = sessionStorage.getItem('syncspace_user_recovery');
            updateAuthUI();
        });
    </script>
</body>
</html>
