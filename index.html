<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncSpace Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f8fafc; /* Light background */
            color: #1f2937; /* Dark text */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            min-height: 120px;
        }
        .day-events::-webkit-scrollbar {
            width: 4px;
        }
        .day-events::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .day-events::-webkit-scrollbar-track {
            background: transparent;
        }
        .logged-out .user-controls {
            display: none;
        }
         .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .event-item .quick-delete-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .event-item:hover .quick-delete-btn {
            opacity: 1;
        }
        /* Active state for view switcher */
        .view-btn-active {
            background-color: white;
            color: #4f46e5;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .timeline-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
        }
        .timeline-chart {
            display: grid;
            overflow-x: auto;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center sticky top-0 z-40 border-b border-gray-200">
        <div>
            <h1 class="text-xl md:text-2xl font-bold text-indigo-600">SyncSpace</h1>
            <p id="lastUpdated" class="text-xs text-gray-500">อัปเดตล่าสุด: -</p>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <!-- Auth Buttons -->
            <div id="authContainer">
                <div id="loggedInView" class="hidden items-center space-x-2">
                     <div class="flex items-center space-x-2">
                        <span class="font-semibold text-sm hidden md:inline text-gray-600">ผู้ใช้:</span>
                        <span id="usernameDisplay" class="text-sm text-gray-800 font-bold"></span>
                    </div>
                    <button id="adminToolsBtn" class="hidden p-2 rounded-full hover:bg-gray-200" title="Tool Management">
                        <i data-lucide="users" class="w-5 h-5 text-gray-600"></i>
                    </button>
                    <button id="logoutButton" class="px-3 py-1.5 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ออกจากระบบ</button>
                </div>
                <div id="loggedOutView" class="flex items-center space-x-2">
                    <button id="loginButton" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">เข้าสู่ระบบ</button>
                    <button id="registerButton" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">สมัครสมาชิก</button>
                </div>
            </div>

             <div class="flex items-center space-x-1 md:space-x-2 border-l border-gray-200 pl-2 md:pl-4 user-controls">
                <button id="saveButton" title="บันทึกข้อมูล" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i data-lucide="save" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="refreshButton" title="รีเฟรชข้อมูล" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
             </div>
             <div class="flex items-center space-x-1 md:space-x-2 border-l border-gray-200 pl-2 md:pl-4">
                <button title="Export to Excel" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i>
                </button>
                <button title="Export to PDF" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i data-lucide="file-text" class="w-5 h-5 text-red-600"></i>
                </button>
                <button title="Export as Image" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <i data-lucide="image" class="w-5 h-5 text-blue-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-6 lg:p-8">
        <!-- Calendar Controls -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i data-lucide="chevron-left" class="w-6 h-6 text-gray-500"></i>
                </button>
                <div class="relative">
                    <h2 id="currentMonthYear" class="text-2xl font-bold text-center w-48 md:w-64 cursor-pointer hover:bg-gray-100 rounded-lg p-2 transition-colors text-gray-800"></h2>
                    <div id="datePicker" class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-white border border-gray-200 rounded-lg shadow-xl p-4 w-72 z-20 hidden">
                        <div class="flex justify-between items-center mb-3">
                            <button id="prevYear" class="p-1.5 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span id="pickerYear" class="font-bold text-lg text-indigo-600"></span>
                            <button id="nextYear" class="p-1.5 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div id="monthGrid" class="grid grid-cols-3 gap-2 text-center text-sm">
                            <!-- Months will be injected here -->
                        </div>
                    </div>
                </div>
                <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i data-lucide="chevron-right" class="w-6 h-6 text-gray-500"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <!-- View Switcher -->
                <div class="flex rounded-lg bg-gray-200 p-1">
                    <button id="calendarViewBtn" class="px-3 py-1 text-sm font-semibold rounded-md view-btn-active">Calendar</button>
                    <button id="timelineViewBtn" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">Timeline</button>
                </div>
                <button id="todayButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold">
                    เดือนปัจจุบัน
                </button>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarViewWrapper">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <div class="calendar-grid border-t border-l border-gray-200">
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50 text-red-500">อา.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">จ.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">อ.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">พ.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">พฤ.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">ศ.</div>
                    <div class="text-center font-semibold py-2 border-r border-b border-gray-200 bg-gray-50">ส.</div>
                    <div id="calendarDays" class="col-span-7 calendar-grid"></div>
                </div>
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timelineViewWrapper" class="hidden">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <div id="timelineContainer" class="max-h-[65vh] overflow-auto">
                    <!-- Timeline content will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden opacity-0 scale-95">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/3 border border-gray-200" id="loginModalContent">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">เข้าสู่ระบบ</h3>
            <form id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                        <input type="text" id="loginUsername" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="loginPassword" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="close-modal px-4 py-2 bg-gray-200 rounded-lg text-gray-800 hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">เข้าสู่ระบบ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden opacity-0 scale-95">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/3 border border-gray-200" id="registerModalContent">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">สมัครสมาชิก</h3>
            <form id="registerForm">
                 <div class="space-y-4">
                    <div>
                        <label for="registerUsername" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                        <input type="text" id="registerUsername" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="registerPassword" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="close-modal px-4 py-2 bg-gray-200 rounded-lg text-gray-800 hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">สมัครสมาชิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Tools Modal -->
    <div id="adminModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden opacity-0 scale-95">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/2 border border-gray-200" id="adminModalContent">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-indigo-600">Tool Management</h3>
                <button class="close-modal p-1 text-gray-500 hover:text-gray-800">&times;</button>
             </div>
             <div id="userList" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Add/Edit Event Modal -->
    <div id="eventModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 hidden opacity-0 scale-95">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/2 lg:w-1/3 border border-gray-200" id="modalContent">
             <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                <h3 class="text-xl font-bold text-indigo-600">จัดการนัดหมาย</h3>
                <button class="close-modal p-1 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800">&times;</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventId">
                <input type="hidden" id="eventDate">
                <p class="mb-4 font-semibold text-gray-700" id="modalDate"></p>
                <div class="space-y-4">
                    <div>
                        <label for="eventTitle" class="block text-sm font-medium text-gray-700">หัวข้อนัดหมาย <span class="text-red-500">*</span></label>
                        <input type="text" id="eventTitle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label for="eventTime" class="block text-sm font-medium text-gray-700">เวลาเริ่มต้น <span class="text-red-500">*</span></label>
                            <input type="time" id="eventTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                         <div>
                            <label for="eventEndTime" class="block text-sm font-medium text-gray-700">เวลาสิ้นสุด</label>
                            <input type="time" id="eventEndTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="eventLocation" class="block text-sm font-medium text-gray-700">สถานที่</label>
                        <input type="text" id="eventLocation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500">
                         <div class="mt-2 flex items-center">
                             <input id="showLocation" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                             <label for="showLocation" class="ml-2 block text-sm text-gray-900">แสดงบนหน้าปฏิทิน</label>
                         </div>
                    </div>
                     
                     <div>
                        <label for="eventDetails" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                        <textarea id="eventDetails" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                     <button type="button" id="deleteEventButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-semibold hidden">ลบนัดหมาย</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold">บันทึกนัดหมาย</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Event Details Modal -->
    <div id="viewEventModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-30 hidden opacity-0 scale-95">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 lg:w-1/4 border border-gray-200" id="viewModalContent">
            <div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-2">
                <h3 class="text-lg font-bold text-indigo-600">รายละเอียดนัดหมาย</h3>
                <button class="close-modal p-1 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800">&times;</button>
            </div>
            <div class="space-y-3" id="viewEventDetails"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const body = document.body;
            const currentMonthYearEl = document.getElementById('currentMonthYear');
            const calendarDaysEl = document.getElementById('calendarDays');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const todayBtn = document.getElementById('todayButton');
            const datePicker = document.getElementById('datePicker');
            const pickerYearEl = document.getElementById('pickerYear');
            const monthGridEl = document.getElementById('monthGrid');
            const prevYearBtn = document.getElementById('prevYear');
            const nextYearBtn = document.getElementById('nextYear');
            const loggedInView = document.getElementById('loggedInView');
            const loggedOutView = document.getElementById('loggedOutView');
            const loginButton = document.getElementById('loginButton');
            const registerButton = document.getElementById('registerButton');
            const logoutButton = document.getElementById('logoutButton');
            const adminToolsBtn = document.getElementById('adminToolsBtn');
            const usernameDisplay = document.getElementById('usernameDisplay');
            const allModals = document.querySelectorAll('.modal');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const adminModal = document.getElementById('adminModal');
            const eventModal = document.getElementById('eventModal');
            const viewEventModal = document.getElementById('viewEventModal');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const eventForm = document.getElementById('eventForm');
            const modalDateEl = document.getElementById('modalDate');
            const deleteEventButton = document.getElementById('deleteEventButton');
            const viewEventDetailsEl = document.getElementById('viewEventDetails');
            const saveBtn = document.getElementById('saveButton');
            const refreshBtn = document.getElementById('refreshButton');
            const lastUpdatedEl = document.getElementById('lastUpdated');

            // View Switcher Elements
            const calendarViewBtn = document.getElementById('calendarViewBtn');
            const timelineViewBtn = document.getElementById('timelineViewBtn');
            const calendarViewWrapper = document.getElementById('calendarViewWrapper');
            const timelineViewWrapper = document.getElementById('timelineViewWrapper');
            const timelineContainer = document.getElementById('timelineContainer');

            const USER_COLORS = ['#6366f1', '#ec4899', '#22c55e', '#f97316', '#0ea5e9', '#8b5cf6', '#d946ef'];

            let currentDate = new Date();
            let pickerCurrentYear = currentDate.getFullYear();
            let currentUser = null;
            let allUsersData = {};
            let events = [];
            let currentView = 'calendar'; // 'calendar' or 'timeline'

            const initializeApp = () => {
                loadData();
                checkSession();
                updateAuthUI();
                renderCurrentView();
                lucide.createIcons();
            };

            const loadData = () => {
                // --- DATA MIGRATION SCRIPT ---
                const migrationNeeded = localStorage.getItem('syncspace_users') && !localStorage.getItem('syncspace_migrated_to_shared_v1');
                if (migrationNeeded) {
                    try {
                        console.log("Running data migration to shared calendar...");
                        const oldUsersData = JSON.parse(localStorage.getItem('syncspace_users'));
                        let migratedEvents = [];
                        let newUsersData = {};
                        let eventIdCounter = Date.now();

                        Object.keys(oldUsersData).forEach((username, index) => {
                            const user = oldUsersData[username];
                            newUsersData[username] = {
                                password: user.password,
                                color: user.color || USER_COLORS[index % USER_COLORS.length]
                            };
                            if (user.events && Array.isArray(user.events)) {
                                user.events.forEach(event => {
                                    migratedEvents.push({
                                        ...event,
                                        id: event.id || eventIdCounter++,
                                        createdBy: username
                                    });
                                });
                            }
                        });
                        
                        localStorage.setItem('syncspace_users', JSON.stringify(newUsersData));
                        localStorage.setItem('syncspace_events', JSON.stringify(migratedEvents));
                        localStorage.setItem('syncspace_migrated_to_shared_v1', 'true');
                        console.log("Data migration complete!");
                    } catch (error) {
                        console.error("Data migration failed:", error);
                    }
                }
                // --- END OF MIGRATION SCRIPT ---

                // Normal data loading
                const users = localStorage.getItem('syncspace_users');
                const sharedEvents = localStorage.getItem('syncspace_events');

                if (users) {
                    allUsersData = JSON.parse(users);
                } else {
                    allUsersData = {
                        'Admin': { password: 'aiteammeeting', color: USER_COLORS[0] }
                    };
                }

                if (sharedEvents) {
                    events = JSON.parse(sharedEvents);
                } else {
                     events = [{ 
                         id: 1, 
                         date: getFormattedDate(new Date()), 
                         title: 'Project Kick-off', 
                         time: '10:00', 
                         endTime: '11:30', 
                         location: 'Main Conference Room', 
                         showLocation: true, 
                         details: 'Initial meeting for the new AI project.',
                         createdBy: 'Admin'
                    }];
                }
                saveData();
            };
            
            const saveData = () => {
                localStorage.setItem('syncspace_users', JSON.stringify(allUsersData));
                localStorage.setItem('syncspace_events', JSON.stringify(events));
            };

            const checkSession = () => {
                const user = sessionStorage.getItem('syncspace_user');
                if (user) currentUser = user;
            };

            const updateAuthUI = () => {
                if (currentUser) {
                    loggedInView.classList.remove('hidden');
                    loggedInView.classList.add('flex');
                    loggedOutView.classList.add('hidden');
                    usernameDisplay.textContent = currentUser;
                    body.classList.remove('logged-out');
                    adminToolsBtn.classList.toggle('hidden', currentUser !== 'Admin');
                } else {
                    loggedInView.classList.add('hidden');
                    loggedOutView.classList.remove('hidden');
                    body.classList.add('logged-out');
                    adminToolsBtn.classList.add('hidden');
                }
                renderCurrentView(); 
            };

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.loginUsername.value;
                const password = e.target.loginPassword.value;
                if (allUsersData[username] && allUsersData[username].password === password) {
                    currentUser = username;
                    sessionStorage.setItem('syncspace_user', currentUser);
                    updateAuthUI();
                    closeAllModals();
                    loginForm.reset();
                } else {
                    alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                }
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.registerUsername.value;
                const password = e.target.registerPassword.value;
                if (allUsersData[username]) {
                    alert('ชื่อผู้ใช้นี้มีอยู่แล้ว');
                } else if (username.toLowerCase() === 'admin') {
                    alert('ไม่สามารถใช้ชื่อนี้ได้');
                } else {
                    const userCount = Object.keys(allUsersData).length;
                    allUsersData[username] = { 
                        password: password, 
                        color: USER_COLORS[userCount % USER_COLORS.length] 
                    };
                    saveData();
                    alert('สมัครสมาชิกสำเร็จ! กรุณาเข้าสู่ระบบ');
                    closeAllModals();
                    registerForm.reset();
                }
            });

            logoutButton.addEventListener('click', () => {
                currentUser = null;
                sessionStorage.removeItem('syncspace_user');
                updateAuthUI();
            });

            const renderUserList = () => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                Object.keys(allUsersData).forEach(username => {
                    if (username === 'Admin') return;
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex justify-between items-center p-2 border border-gray-200 rounded-lg bg-gray-50';
                    userDiv.innerHTML = `<span>${username}</span><button data-user="${username}" class="delete-user-btn p-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    userList.appendChild(userDiv);
                });
                lucide.createIcons();
            };

            adminToolsBtn.addEventListener('click', () => {
                renderUserList();
                openModal(adminModal);
            });
            
            document.getElementById('userList').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-user-btn');
                if (deleteBtn) {
                    const userToDelete = deleteBtn.dataset.user;
                    if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ ${userToDelete}?`)) {
                        delete allUsersData[userToDelete];
                        saveData();
                        renderUserList();
                    }
                }
            });

            saveBtn.addEventListener('click', () => {
                if(!currentUser) return alert("กรุณาเข้าสู่ระบบเพื่อบันทึกข้อมูล");
                saveData();
                alert('บันทึกข้อมูลทั้งหมดแล้ว');
                updateLastUpdated();
            });

            refreshBtn.addEventListener('click', () => {
                if (confirm('ข้อมูลที่ยังไม่บันทึกจะหายไป, ต้องการรีเฟรชหรือไม่?')) {
                    loadData();
                    renderCurrentView();
                }
            });
            
            const getFormattedDate = date => date.toISOString().split('T')[0];

            // --- View Rendering Logic ---
            const renderCurrentView = () => {
                updateLastUpdated();
                if (currentView === 'calendar') {
                    renderCalendar();
                } else {
                    renderTimeline();
                }
            }

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = new Intl.DateTimeFormat('th-TH', { month: 'long', year: 'numeric' }).format(currentDate);
                currentMonthYearEl.textContent = monthName;
                calendarDaysEl.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarDaysEl.insertAdjacentHTML('beforeend', `<div class="border-r border-b border-gray-200 p-2 bg-gray-50"></div>`);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day border-r border-b border-gray-200 p-2 flex flex-col relative group transition-colors hover:bg-indigo-50';
                    dayEl.dataset.date = dateStr;

                    const dayNumberDiv = document.createElement('div');
                    dayNumberDiv.textContent = day;
                    dayNumberDiv.className = "w-8 h-8 flex items-center justify-center mb-2 font-medium";

                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                        dayNumberDiv.classList.add('bg-indigo-600', 'text-white', 'rounded-full');
                    }
                    
                    const dayEvents = events.filter(e => e.date === dateStr);
                    dayEvents.sort((a,b) => a.time.localeCompare(b.time));
                    
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'day-events flex-grow overflow-y-auto space-y-1';
                    dayEvents.forEach(event => eventsContainer.appendChild(createEventElement(event)));
                    
                    dayEl.append(dayNumberDiv, eventsContainer);
                    
                    if (currentUser) {
                        const addEventBtn = document.createElement('button');
                        addEventBtn.className = 'absolute top-1 right-1 p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity';
                        addEventBtn.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i>`;
                        addEventBtn.onclick = (e) => { e.stopPropagation(); openEventModalForAdd(dateStr); };
                        dayEl.onclick = () => openEventModalForAdd(dateStr);
                        dayEl.appendChild(addEventBtn);
                    }
                    calendarDaysEl.appendChild(dayEl);
                }
                lucide.createIcons();
            };

            const renderTimeline = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let headerHtml = '<div class="sticky top-0 z-10 grid grid-cols-12 bg-gray-50 border-b-2 border-gray-200"><div class="col-span-3 p-2 font-semibold">หัวข้อ</div><div class="col-span-9 grid" style="grid-template-columns: repeat(' + daysInMonth + ', minmax(40px, 1fr));">';
                for(let i = 1; i <= daysInMonth; i++) {
                    headerHtml += `<div class="text-center text-sm font-medium p-2 border-l border-gray-200">${i}</div>`;
                }
                headerHtml += '</div></div>';

                let bodyHtml = '';
                const eventsForMonth = events
                    .filter(event => {
                        const eventDate = new Date(event.date + 'T00:00:00');
                        return eventDate.getFullYear() === year && eventDate.getMonth() === month;
                    })
                    .sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                
                if (eventsForMonth.length === 0) {
                     timelineContainer.innerHTML = '<p class="text-gray-500 text-center py-8">ไม่มีนัดหมายในเดือนนี้</p>';
                     return;
                }
                
                eventsForMonth.forEach(event => {
                    const eventDay = new Date(event.date + 'T00:00:00').getDate();
                    const userColor = allUsersData[event.createdBy]?.color || '#a5b4fc';

                    bodyHtml += `<div class="grid grid-cols-12 border-b border-gray-100 items-center hover:bg-gray-50 cursor-pointer" onclick="openViewModal(${event.id})">`;
                    bodyHtml += `<div class="col-span-3 p-2 text-sm font-semibold truncate" title="${event.title}">${event.title}</div>`;
                    bodyHtml += `<div class="col-span-9 grid h-full" style="grid-template-columns: repeat(${daysInMonth}, minmax(40px, 1fr));">`;
                    bodyHtml += `<div class="h-full py-2" style="grid-column-start: ${eventDay};">`;
                    bodyHtml += `<div class="h-full rounded-md text-white text-xs px-2 flex items-center" style="background-color: ${userColor}" title="${event.title} (${event.createdBy})">${event.createdBy}</div>`;
                    bodyHtml += `</div>`;
                    bodyHtml += `</div></div>`;
                });
                
                timelineContainer.innerHTML = headerHtml + bodyHtml;
                // Dirty hack to make onclick work on dynamically generated html
                window.openViewModal = openViewModal;
            };

            const setView = (view) => {
                currentView = view;
                if (view === 'calendar') {
                    calendarViewWrapper.classList.remove('hidden');
                    timelineViewWrapper.classList.add('hidden');
                    calendarViewBtn.classList.add('view-btn-active', 'text-indigo-600');
                    calendarViewBtn.classList.remove('text-gray-600');
                    timelineViewBtn.classList.remove('view-btn-active', 'text-indigo-600');
                    timelineViewBtn.classList.add('text-gray-600');
                } else {
                    calendarViewWrapper.classList.add('hidden');
                    timelineViewWrapper.classList.remove('hidden');
                    timelineViewBtn.classList.add('view-btn-active', 'text-indigo-600');
                    timelineViewBtn.classList.remove('text-gray-600');
                    calendarViewBtn.classList.remove('view-btn-active', 'text-indigo-600');
                    calendarViewBtn.classList.add('text-gray-600');
                }
                renderCurrentView();
            };

            calendarViewBtn.addEventListener('click', () => setView('calendar'));
            timelineViewBtn.addEventListener('click', () => setView('timeline'));


            const createEventElement = (event) => {
                const eventEl = document.createElement('div');
                const userColor = allUsersData[event.createdBy]?.color || '#d1d5db';
                eventEl.className = 'event-item text-xs p-1 rounded-md cursor-pointer flex justify-between items-center';
                eventEl.style.backgroundColor = `${userColor}20`; // a bit of opacity
                eventEl.style.borderLeft = `3px solid ${userColor}`;
                
                const textSpan = document.createElement('span');
                textSpan.className = 'truncate pl-1';
                textSpan.style.color = `${userColor}`;
                textSpan.textContent = `${event.title}`;
                eventEl.appendChild(textSpan);

                eventEl.onclick = (e) => { e.stopPropagation(); openViewModal(event.id); };

                if (currentUser) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'quick-delete-btn ml-1 p-0.5 rounded-full text-red-500 hover:bg-red-200';
                    deleteBtn.innerHTML = `<i data-lucide="x" class="w-3 h-3"></i>`;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบนัดหมาย "${event.title}"?`)) {
                            events = events.filter(ev => ev.id !== event.id);
                            renderCurrentView();
                        }
                    };
                    eventEl.appendChild(deleteBtn);
                }
                return eventEl;
            };
            
            const openModal = modalEl => {
                modalEl.classList.remove('hidden');
                setTimeout(() => modalEl.classList.remove('opacity-0', 'scale-95'), 10);
            };
            
            const closeModal = modalEl => {
                modalEl.classList.add('opacity-0', 'scale-95');
                setTimeout(() => modalEl.classList.add('hidden'), 300);
            };
            
            const closeAllModals = () => allModals.forEach(closeModal);
            
            document.querySelectorAll('.close-modal').forEach(btn => btn.onclick = () => closeModal(btn.closest('.modal')));

            loginButton.onclick = () => openModal(loginModal);
            registerButton.onclick = () => openModal(registerModal);

            const openEventModalForAdd = (dateStr) => {
                if(!currentUser) return alert("กรุณาเข้าสู่ระบบเพื่อเพิ่มนัดหมาย");
                eventForm.reset();
                modalDateEl.textContent = new Intl.DateTimeFormat('th-TH', { dateStyle: 'full' }).format(new Date(dateStr + 'T00:00:00'));
                document.getElementById('eventDate').value = dateStr;
                document.getElementById('eventId').value = '';
                deleteEventButton.classList.add('hidden');
                openModal(eventModal);
            };

            const openEventModalForEdit = (eventId) => {
                if(!currentUser) return;
                const event = events.find(e => e.id === eventId);
                if (event) {
                    openEventModalForAdd(event.date); 
                    Object.keys(event).forEach(key => {
                        const el = document.getElementById(`event${key.charAt(0).toUpperCase() + key.slice(1)}`);
                        if (el) el.type === 'checkbox' ? el.checked = event[key] : el.value = event[key];
                    });
                    deleteEventButton.classList.remove('hidden');
                }
            };
            
            const openViewModal = (eventId) => {
                const event = events.find(e => e.id === eventId);
                if (!event) return;
                
                const editButtonHtml = currentUser ? `<button id="editFromViewBtn" class="mt-4 w-full text-sm px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 font-semibold">แก้ไข</button>` : '';
                let timeText = event.endTime ? `${event.time} - ${event.endTime}` : event.time;

                viewEventDetailsEl.innerHTML = `
                    <p><strong>หัวข้อ:</strong> ${event.title}</p>
                    <p><strong>ผู้สร้าง:</strong> ${event.createdBy}</p>
                    <p><strong>วันที่:</strong> ${new Intl.DateTimeFormat('th-TH', { dateStyle: 'full' }).format(new Date(event.date+'T00:00:00'))}</p>
                    <p><strong>เวลา:</strong> ${timeText}</p>
                    ${event.location ? `<p><strong>สถานที่:</strong> ${event.location}</p>` : ''}
                    ${event.details ? `<p class="mt-2 pt-2 border-t border-gray-200"><strong>รายละเอียด:</strong><br>${event.details.replace(/\n/g, '<br>')}</p>` : ''}
                    ${editButtonHtml}
                `;
                
                if (currentUser) {
                    document.getElementById('editFromViewBtn').onclick = () => { closeAllModals(); openEventModalForEdit(eventId); };
                }
                openModal(viewEventModal);
            };

            eventForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if(!currentUser) return;
                const id = document.getElementById('eventId').value;
                const newEvent = {
                    id: id ? parseInt(id) : Date.now(),
                    date: document.getElementById('eventDate').value,
                    title: document.getElementById('eventTitle').value,
                    location: document.getElementById('eventLocation').value,
                    showLocation: document.getElementById('showLocation').checked,
                    time: document.getElementById('eventTime').value,
                    endTime: document.getElementById('eventEndTime').value,
                    details: document.getElementById('eventDetails').value,
                    createdBy: currentUser
                };
                
                if (id) events = events.map(event => event.id === newEvent.id ? newEvent : event);
                else events.push(newEvent);
                closeAllModals();
                renderCurrentView();
            });

            deleteEventButton.onclick = () => {
                const id = parseInt(document.getElementById('eventId').value);
                if (confirm('คุณต้องการลบนัดหมายนี้ใช่หรือไม่?')) {
                    events = events.filter(event => event.id !== id);
                    closeAllModals();
                    renderCurrentView();
                }
            };

            const updateLastUpdated = () => lastUpdatedEl.textContent = `อัปเดตล่าสุด: ${new Intl.DateTimeFormat('th-TH', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date())}`;

            const renderDatePicker = (year) => {
                pickerCurrentYear = year;
                pickerYearEl.textContent = year + 543;
                monthGridEl.innerHTML = '';
                const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                thaiMonths.forEach((month, index) => {
                    const monthBtn = document.createElement('button');
                    monthBtn.textContent = month;
                    monthBtn.className = 'p-2 hover:bg-gray-100 rounded-md';
                    monthBtn.onclick = () => {
                        currentDate = new Date(pickerCurrentYear, index, 1);
                        renderCurrentView();
                        datePicker.classList.add('hidden');
                    };
                    monthGridEl.appendChild(monthBtn);
                });
            };

            currentMonthYearEl.addEventListener('click', () => {
                renderDatePicker(currentDate.getFullYear());
                datePicker.classList.toggle('hidden');
            });
            prevYearBtn.onclick = () => renderDatePicker(pickerCurrentYear - 1);
            nextYearBtn.onclick = () => renderDatePicker(pickerCurrentYear + 1);
            
            prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCurrentView(); };
            nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCurrentView(); };
            todayBtn.onclick = () => { currentDate = new Date(); renderCurrentView(); };
            
            document.addEventListener('click', (e) => {
                if (!currentMonthYearEl.parentElement.contains(e.target)) datePicker.classList.add('hidden');
            });
            
            initializeApp();
        });
    </script>
</body>
</html>

